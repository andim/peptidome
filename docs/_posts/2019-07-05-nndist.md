---
layout: post
title: Distributions of nearest neighbor distances
---

Is the finiteness of the self proteome important?

{% include post-image-gallery.html filter="nndist/" %}

### Code 
#### nndist-math.ipynb



```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
%matplotlib inline
plt.style.use('../peptidome.mplstyle')
#plt.style.use('talk')

import sys
sys.path.append('..')

from lib import *
```


```python
def nndist_probability(k, N):
    K = 20**k
    d = np.arange(0, k+1)
    Nc = lambda d: 19**d * falling_factorial(k, d+1)
    Ncs = Nc(d)
    cumulative = [0]
    cumulative.extend(1-np.exp(-np.cumsum(Ncs)*N/K))
    p = np.diff(cumulative)
    return d, p
```


```python
fig, ax = plt.subplots()
N = 1e7
for k in range(5, 13):
    d, p = nndist_probability(k, N)
    ax.plot(d, p, '-o', label=k)
ax.set_ylim(0, 1)
ax.legend(title='Peptide length')
ax.set_xlim(0, 7)
ax.set_ylabel('Probability')
ax.set_xlabel('Nearest neighbor distance ($N=10^{ %g }$)'%np.log10(N))
fig.savefig('nndist_uniform.png')
```


![png](notebook_files/nndist-math_2_0.png)



```python

```
#### nn_analysis.ipynb



```python
import numpy as np
import pandas as pd
from scipy.stats import entropy
import scipy.stats
from scipy.stats import poisson
import seaborn as sns
import sklearn.neighbors
import matplotlib.pyplot as plt
%matplotlib inline

import Levenshtein

import sys
sys.path.append('..')
from lib import *

plt.style.use('../peptidome.mplstyle')
```


```python
df_t = load_iedb_tcellepitopes()
```


```python
S = 20
k = 9

Ntot = S**k
Nn = k*(S-1)
```


```python
counter9 = count_kmers_proteome(human, k, clean=True)
human9 = set(counter9)
Nhuman = len(human9)
```


```python
counterm9 = count_kmers_proteome(proteome_path('Mouse'), k, clean=True)
mouse9 = set(counterm9)
```


```python
df_t['Host', 'Name'].value_counts()
```




    Homo sapiens                                                    208781
    Mus musculus C57BL/6                                             29792
    Mus musculus BALB/c                                              20713
    Mus musculus                                                      5414
    Homo sapiens Caucasian                                            3969
    Rattus norvegicus Lewis                                           3708
    Mus musculus SJL                                                  3507
    Mus musculus C57BL/6 HLA-A*0201/Kb Tg X BALB/c                    2901
    Bos taurus                                                        2143
    Mus musculus NOD                                                  2055
    Mus musculus C3H/He                                               2048
    Pan troglodytes                                                   1497
    Sus scrofa Landrace X Large White                                 1330
    Mus musculus C57BL/6 X BALB/c                                     1251
    Mus musculus HLA-DR1 Tg                                           1236
    Macaca mulatta                                                    1214
    Mus musculus C57BL/10                                             1160
    Mus musculus HLA-DR4 Tg                                           1059
    Mus musculus A/J                                                   990
    Mus musculus HLA-DR3 Tg                                            978
    Mus musculus HLA-A*0201/Db-human b2m Tg (HHD)                      834
    Mus musculus B10.BR                                                789
    Mus musculus HLA-A*0201 Tg                                         788
    Mus musculus HLA-A2 Tg                                             768
    Mus musculus HLA-DQ8 Tg                                            761
    Mus musculus CBA                                                   737
    Mus musculus DBA/1                                                 684
    Mus musculus HLA-DRB1*1501 Tg                                      673
    Mus musculus IFNR null                                             577
    Mus musculus HLA-DR2 Tg                                            576
                                                                     ...  
    Mus musculus B10.A(4R) Kbw9                                          1
    Mus musculus C57BL/10 X C3H/HeJ                                      1
    Mus musculus B6.129P2-B2m tm1Unc/J                                   1
    Oryctolagus cuniculus EIII/JC                                        1
    Mus musculus APP/TGF-beta1                                           1
    Mus musculus C57BL/6 HLA-B27 Tg human beta2m Tg human CD8 Tg         1
    Mus musculus B6.129S2-Cd28tm1Mak                                     1
    Mus musculus B10.A(18R)                                              1
    Mus musculus Pten fl/fl GBC                                          1
    Mus musculus C3H.JK                                                  1
    Mus musculus C3H/FeJ X C57BL/6                                       1
    Mus musculus RIP-B7 H2d/d                                            1
    Cairina moschata                                                     1
    Mus musculus OF1                                                     1
    Mus musculus C57BL/6 X B10.D2                                        1
    Mus musculus Flu (PR8) HA Tg                                         1
    Mus musculus C57BL/6 OX40 null                                       1
    Mus musculus RIP-OVA                                                 1
    Mus musculus PLP TCR Tg                                              1
    Mus musculus Matahari TCR Tg                                         1
    Mus musculus C57BL/6 F5 TCR Tg RAG-1 null                            1
    Mus musculus BALB/c X B10.BR                                         1
    Mus musculus DbGagL TCR Tg                                           1
    Mus musculus CBA X AKR                                               1
    Mus musculus NOD-Ealpha Tg                                           1
    Mus musculus NOD HLA-B*0702 Tg                                       1
    Rattus norvegicus LEWIS.1AR1                                         1
    Mus musculus Kb null                                                 1
    Mus musculus BXSB                                                    1
    Rattus norvegicus LEWIS.1AR2                                         1
    Name: (Host, Name), Length: 587, dtype: int64




```python
np.sum(df_t['Host', 'Name'].str.contains('Mus musculus', na=False)), np.sum(df_t['Host', 'Name'].str.contains('Homo sapiens', na=False))
```




    (104748, 212825)




```python
# only human hosts
mask = df_t['Host', 'Name'].str.contains('Homo sapiens', na=False)
# no human epitopes or epitopes of unknown provenance
mask &= ~df_t['Epitope', 'Parent Species'].str.contains('Homo sapiens', na=True)
# only epitopes of length 9
mask &= df_t['Epitope', 'Description'].apply(len)==9
d = df_t[mask]
d['1st in vivo Process', 'Process Type'].value_counts()
```




    Administration in vivo                                                             15122
    Occurrence of infectious disease                                                    5965
    Exposure with existing immune reactivity without evidence for disease               3684
    Environmental exposure to endemic/ubiquitous agent without evidence for disease     2664
    No immunization                                                                      994
    Documented exposure without evidence for disease                                     244
    Exposure without evidence for disease                                                147
    Occurrence of autoimmune disease                                                      94
    Occurrence of cancer                                                                  89
    Occurrence of allergy                                                                 55
    Occurrence of disease                                                                 24
    Unknown                                                                               17
    Transplant/transfusion                                                                16
    Name: (1st in vivo Process, Process Type), dtype: int64




```python
mask = df_t['Host', 'Name'].str.contains('Mus musculus', na=False)
df_t[mask]['Epitope', 'Parent Species'].value_counts().head()
```




    Mus musculus                                   11569
    Vaccinia virus                                  9686
    Homo sapiens                                    9411
    Influenza A virus                               6885
    Lymphocytic choriomeningitis mammarenavirus     5211
    Name: (Epitope, Parent Species), dtype: int64



## Response frequency as a function of distance


```python
host = 'Homo sapiens'
exclude = host
selfset = human9
```


```python
host = 'Mus musculus C57BL/6'
exclude = 'Mus musculus'
selfset = mouse9
```


```python
# only specified hosts
mask = df_t['Host', 'Name'].str.contains(host, na=False)
#mask &= ~df_t['Host', 'Name'].str.contains('HLA', na=False)
# only epitopes of length 9
mask &= df_t['Epitope', 'Description'].apply(len)==9
# no host epitopes or epitopes of unknown provenance
mask &= ~df_t['Epitope', 'Parent Species'].str.contains(host, na=True)
#mask &= ~df_t['Epitope', 'Parent Species'].str.contains('Homo sapiens', na=True)
d = df_t[mask]
```


```python
dg = d.groupby(('Epitope', 'Description'))
```


```python
d.columns = [' '.join(col).strip() for col in d.columns.values]
```


```python
d['Assay Qualitative Measure'] = d['Assay Qualitative Measure'] == 'Negative'
```

    /home/amayer/.conda/envs/py3/lib/python3.6/site-packages/ipykernel_launcher.py:1: SettingWithCopyWarning: 
    A value is trying to be set on a copy of a slice from a DataFrame.
    Try using .loc[row_indexer,col_indexer] = value instead
    
    See the caveats in the documentation: http://pandas.pydata.org/pandas-docs/stable/indexing.html#indexing-view-versus-copy
      """Entry point for launching an IPython kernel.



```python
dfaq = d.groupby('Epitope Description')['Assay Qualitative Measure'].mean()
```


```python
plt.hist(dfaq);
```


![png](notebook_files/nn_analysis_17_0.png)



```python
# only specified hosts
mask = df_t['Host', 'Name'].str.match(host, na=False)
# only epitopes of length 9
mask &= df_t['Epitope', 'Description'].apply(len)==9
# no host epitopes or epitopes of unknown provenance
mask &= ~df_t['Epitope', 'Parent Species'].str.contains(exclude, na=True)
d = df_t[mask]
# uniquify epitopes by keeping only the first one
d = d.groupby(('Epitope', 'Description')).apply(lambda x: x.iloc[0])
d0 = d['Epitope', 'Description'].apply(lambda x: x in selfset)
count0 = np.sum(d0)
d1 = d['Epitope', 'Description'].apply(lambda x: dist1(x, selfset)) & (~d0)
count1 = np.sum(d1)
d2 = d['Epitope', 'Description'].apply(lambda x: dist2(x, selfset)) & (~d0) & (~d1)
count2 = np.sum(d2)
pos0 = d[d0][~(d[d0]['Assay', 'Qualitative Measure'] == 'Negative')].shape[0]
pos1 = d[d1][~(d[d1]['Assay', 'Qualitative Measure'] == 'Negative')].shape[0]
pos2 = d[d2][~(d[d2]['Assay', 'Qualitative Measure'] == 'Negative')].shape[0]
posall = d[(~(d['Assay', 'Qualitative Measure'] == 'Negative')) & (~d0) & (~d1) & (~d2)].shape[0]
ns = np.array([count0, count1, count2, d.shape[0]-count0-count1-count2])
ps = np.array([pos0, pos1, pos2, posall])/ns
ns, ps
```




    (array([  46,  185, 3728, 4569]),
     array([0.2173913 , 0.36216216, 0.33127682, 0.27205078]))




```python
fig, ax = plt.subplots(figsize=(2.5, 1.75))
ax.errorbar(range(4), ps, (ps*(1-ps)/ns)**.5)
ax.set_ylim(0, 0.45)
ax.set_xlabel('Distance to self')
ax.set_ylabel('Fraction positive assays')
fig.tight_layout()
fig.savefig('main.png' if exclude == 'Homo sapiens' else exclude + '.png')
```


![png](notebook_files/nn_analysis_19_0.png)


## Nearest neighbor frequencies using human statistics


```python
df = Counter(human, 1).to_df(norm=True, clean=True)
pi = np.asarray(df['freq'])

psigmas = []
nsigmas = []
Nsample = 1000000
for i in range(Nsample):
    sigma = np.random.randint(0, S, k)
    psigma = np.prod(pi[sigma])
    nsigma = np.prod(pi[sigma])*(np.sum(1/pi[sigma]) - k)
    psigmas.append(psigma)
    nsigmas.append(nsigma)
nsigmas = np.asarray(nsigmas)
psigmas = np.asarray(psigmas)

p0 = 1/Ntot
pp = Ntot*np.mean(psigmas**2)
print(pp, p0)
n0 = Nn/Ntot
n = Ntot*np.mean(psigmas*nsigmas)
print(n0, n)
```

    9.670606346099504e-12 1.953125e-12
    3.33984375e-10 1.3682524332048525e-09



```python
tripletparams = calc_tripletmodelparams(human)
```


```python
ptri = lambda seq: 10**loglikelihood_triplet(map_numbertoaa(seq), **tripletparams)

```


```python
psigmas = []
Nsample = 1000000
for i in range(Nsample):
    sigma = np.random.randint(0, S, k)
    psigma = ptri(sigma)
    psigmas.append(psigma)
    nsigma = np.prod(pi[sigma])*(np.sum(1/pi[sigma]) - k)
psigmas = np.asarray(psigmas)

pptri = Ntot*np.mean(psigmas**2)
pptri
```




    1.5403344731966732e-11




```python
def neighbors(sigma, S):
    for i in range(len(sigma)):
        for s in range(S):
            if not sigma[i] == s:
                yield np.asarray(list(sigma[:i]) + [s] + list(sigma[i+1:]))
```


```python
psigmas = []
nsigmas = []
Nsample = 10000
for i in range(Nsample):
    sigma = np.random.randint(0, S, k)
    psigma = ptri(sigma)
    nsigma = np.sum(np.fromiter((ptri(sigmap) for sigmap in neighbors(sigma, S)), np.float))
    psigmas.append(psigma)
    nsigmas.append(nsigma)
psigmas = np.asarray(psigmas)
nsigmas = np.asarray(nsigmas)

pptri = Ntot*np.mean(psigmas**2)
ntri = Ntot*np.mean(psigmas*nsigmas)
print(pptri, ntri/Nn)
```

    1.7704463121379293e-11 1.3095434528450956e-11



```python
# only human hosts
mask = df_t['Host', 'Name'].str.contains('Homo sapiens', na=False)
# no epitopes of unknown provenance
mask &= ~df_t['Epitope', 'Parent Species'].isna()
# only epitopes of length 9
mask &= df_t['Epitope', 'Description'].apply(len)==9

mask_noh = mask[:]
mask_noh &= ~df_t['Epitope', 'Parent Species'].str.contains('Homo sapiens', na=True)
mask1 = mask_noh[:]
mask1 &= ~(df_t['Assay', 'Qualitative Measure'] == 'Negative')
mask2 = mask_noh[:]
mask2 &= df_t['Assay', 'Qualitative Measure'] == 'Negative'

mask_noh &= ~(df_t['Assay', 'Qualitative Measure'] == 'Negative')
mask3 = mask_noh[:]
mask3 &= df_t['1st in vivo Process', 'Process Type'] == 'Occurrence of infectious disease'
mask4 = mask_noh[:]
mask4 &= df_t['1st in vivo Process', 'Process Type'] == 'Occurrence of allergy'
mask5 = mask.copy()
mask5 &= ~(df_t['Assay', 'Qualitative Measure'] == 'Negative')
mask5 &= df_t['1st in vivo Process', 'Process Type'] == 'Occurrence of autoimmune disease'
mask5 &= df_t['Epitope', 'Parent Species'].str.contains('Homo sapiens', na=False)
mask6 = mask[:]
mask6 &= ~(df_t['Assay', 'Qualitative Measure'] == 'Negative')
mask6 &= (df_t['1st in vivo Process', 'Process Type'] == 'Occurrence of cancer')
```


```python
Nhuman_tot = sum(val for val in counter9.values())
Nhuman_tot, Nhuman
```




    (11349410, 10401757)




```python
cases = [('positive', mask1),
         ('negative', mask2),
         ('pos infectious', mask3),
         ('pos cancer', mask6),
        ]
fig, axes = plt.subplots(figsize=(3.42, 2.0*len(cases)), nrows=len(cases), sharex=False)
for i, (name, mask) in enumerate(cases):
    print(name)
    ax = axes[i]
    d = df_t[mask]
    d0 = d['Epitope', 'Description'].apply(lambda x: x in human9)
    count0 = np.sum(d0)
    count1 = np.sum(d['Epitope', 'Description'].apply(lambda x: dist1(x, human9)) & (~d0))
    print(count0, count1)
    ax.axvline(count1/d.shape[0], c='k')
    ax.set_title(name + ' N = %g' % d.shape[0])
    xmax = 0.05
    x = np.arange(0, xmax*d.shape[0])
    Ncomp = d.shape[0]*Nhuman
    mu = Ncomp*n0
    ax.plot(x/d.shape[0], poisson.pmf(x, mu), '-', ms=8, label='flat')
    mu = Ncomp*n
    ax.plot(x/d.shape[0], poisson.pmf(x, mu), '-', ms=8, label='independent')
    mu = Ncomp*ntri
    ax.plot(x/d.shape[0], poisson.pmf(x, mu), '-', ms=8, label='tri')
    ax.set_ylim(0.0)
    ax.set_xlim(0.0, xmax)
    ax.set_yticks([])
ax.set_xlabel('Peptides at distance 1 to self')
fig.tight_layout()
```

    positive
    25 260
    negative
    88 330
    pos infectious
    8 104
    pos cancer
    251 5



![png](notebook_files/nn_analysis_29_1.png)



```python
def nndist_probability(k, N):
    K = 20**k
    d = np.arange(0, k+1)
    Nc = lambda d: 19**d * falling_factorial(k, d+1)
    Ncs = Nc(d)
    cumulative = [0]
    cumulative.extend(1-np.exp(-np.cumsum(Ncs)*N/K))
    p = np.diff(cumulative)
    return d, p
```


```python
human_9mers = np.array(list(human9))
```


```python
humansample = np.random.choice(human_9mers, 1000)
```


```python
selfset = human9
count0 = 0
d1 = np.array([dist1(x, selfset) for x in humansample])
count1 = np.sum(d1)
d2 = np.array([dist2(x, selfset) for x in humansample]) & (~d1)
count2 = np.sum(d2)
ns_self = np.array([count0, count1, count2, len(humansample)-count0-count1-count2])
```


```python
ns_self
```




    array([  0, 141, 526, 333])




```python
fig, ax = plt.subplots(figsize=(2, 1.5))
N = len(human9)
k = 9
d, p = nndist_probability(k, N)
ax.plot(d[:4], [p[0], p[1], p[2], np.sum(p[3:])], '-o', label='uniform')
ax.plot(range(4), ns/np.sum(ns), '-o', label='epitopes')
ax.plot(range(1, 4), ns_self[1:]/np.sum(ns_self[1:]), '-o', label='self')
#ax.plot([0, 1], [pptri*N, ntri*N], '-o')
ax.set_ylim(1e-5, 1)
ax.legend()
ax.set_yscale('log')
ax.set_ylabel('Fraction')
ax.set_xlabel('Distance to self')
fig.savefig('neighbors.png')
```


![png](notebook_files/nn_analysis_35_0.png)


# Analysis of flu epitopes


```python
fluepis = df_t[df_t['Epitope', 'Parent Species'] == 'Influenza A virus']#['Epitope', 'Description'].unique()
fluepis.shape
```




    (11833, 141)




```python
fluepis['Epitope', 'Description'].unique().shape
```




    (4561,)




```python
plt.hist([len(s) for s in fluepis['Epitope', 'Description'].unique()], bins=np.arange(8, 21))
```




    (array([ 132.,  470.,  190.,   63.,   32.,   96.,   69., 1265.,  127.,
            1200.,  506.,  297.]),
     array([ 8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]),
     <a list of 12 Patch objects>)




![png](notebook_files/nn_analysis_39_1.png)



```python
nchunks = 100
btdist = BallTreeDist(human9, nchunks=nchunks)
```


```python
fluepis9 = fluepis[fluepis['Epitope', 'Description'].apply(len)==9]
#list(fluepis9['Epitope', 'Description'].unique())
```


```python
fludists = [btdist.mindist(e) for e in list(fluepis9['Epitope', 'Description'].unique())]
```


```python
np.histogram(fludists, np.arange(0, 6))
```




    (array([  0,  10, 206, 252,   2]), array([0, 1, 2, 3, 4, 5]))




```python
proteomes = load_proteomes()

```


```python
df_flua = counter_to_df(count_kmers_proteome(datadir + proteomes.loc['InfluenzaA']['path'], 9), norm=True)
df_flua.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seq</th>
      <th>freq</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MDSNTMSSF</td>
      <td>0.000627</td>
    </tr>
    <tr>
      <th>1</th>
      <td>DSNTMSSFQ</td>
      <td>0.000627</td>
    </tr>
    <tr>
      <th>2</th>
      <td>SNTMSSFQV</td>
      <td>0.000313</td>
    </tr>
    <tr>
      <th>3</th>
      <td>NTMSSFQVD</td>
      <td>0.000313</td>
    </tr>
    <tr>
      <th>4</th>
      <td>TMSSFQVDC</td>
      <td>0.000313</td>
    </tr>
  </tbody>
</table>
</div>




```python
distss = []
for i in range(3):
    peptides = np.random.choice(df_flua['seq'], size=int(len(fludists)), replace=False, p=df_flua['freq'])
    dists = [btdist.mindist(e) for e in peptides]
    distss.append(dists)
```


```python
counts = np.bincount(fludists)
print(counts)
plt.plot(counts, 'o')
for d in [distss[0], distss[1], distss[2]]:
    counts = np.bincount(d)
    print(counts)
    plt.plot(counts, 'kx')
```

    [  0  10 206 252   2]
    [ 0  0 26 21]
    [ 0  0 20 27]
    [ 0  2 20 25]



![png](notebook_files/nn_analysis_47_1.png)



```python
def dists_direct(df, ref):
    d0 = df[df['seq'].apply(lambda x: x in ref)].shape[0]/df['seq'].shape[0]
    d1 = df[df['seq'].apply(dist1)].shape[0]/df['seq'].shape[0]
    d2 = df[df['seq'].apply(dist2)].shape[0]/df['seq'].shape[0]
    return d0, d1, d2
```


```python
distsallflu = dists_direct(df_flua, human9)
```


```python
counts = np.bincount(fludists)
plt.plot(counts/np.sum(counts), 'o')
plt.plot(distsallflu, 'x')

N = sum(counter9.values())
print('%e'%N)
k = 9
K = 20**k

dists = np.arange(6)
Nc = 19**dists * falling_factorial(k, dists+1)
cumulative = [0]
cumulative.extend(1-np.exp(-Nc*N/K))
plt.plot(dists, np.diff(cumulative), '+')
plt.ylim(0.0)
```


```python
hivepis = d[d['Epitope', 'Parent Species'] == 'Human immunodeficiency virus 1']['Epitope', 'Description'].unique()
hivepis.shape
```


```python
hivdists = [mindist_sklearn_chunked(e, bts) for e in hivepis]
```


```python
counts = np.bincount(hivdists)
print(counts)
plt.plot(counts, 'x')
```


```python
df_hiv1 = counter_to_df(count_kmers_proteome(datadir + proteomes.loc['HIV']['path'], 9), norm=True)
df_hiv1.head()
```


```python
distss_hiv = []
for i in range(3):
    peptides = np.random.choice(df_hiv1['seq'], size=len(hivdists), replace=False, p=df_hiv1['freq'])
    dists = [mindist_sklearn_chunked(e, bts) for e in peptides]
    distss_hiv.append(dists)
```


```python
counts = np.bincount(hivdists)
print(counts)
plt.plot(counts, 'o')
for d in distss_hiv:
    counts = np.bincount(d)
    print(counts)
    plt.plot(counts, 'kx')
```


```python
distsallhiv = dists_direct(df_hiv1, human9)
```


```python
counts = np.bincount(hivdists)
plt.plot(counts/np.sum(counts), 'o')
plt.plot(distsallhiv, 'x')
N = sum(counter9.values())
print('%e'%N)
k = 9
K = 20**k

dists = np.arange(6)
Nc = lambda d: 19**dists * falling_factorial(k, dists+1)
cumulative = [0]
cumulative.extend(1-np.exp(-Nc(dists)*N/K))
plt.plot(dists, np.diff(cumulative), '+')
plt.ylim(0.0)
```


```python

```
#### benchmark.ipynb


# Benchmarking hamming distance calculation


```python
import numpy as np
import pandas as pd
from scipy.stats import entropy
import scipy.stats
import seaborn as sns
import sklearn.neighbors
import matplotlib.pyplot as plt
%matplotlib inline

import Levenshtein

import sys
sys.path.append('..')

from lib import *

%load_ext Cython
```


```python
k = 9
counter9 = count_kmers_proteome(human, k, clean=True)
human9 = set(counter9)
```


```python
humansample = random.sample(human9, 100000)
points = np.asarray([map_aatonumber(h) for h in humansample])

```


```python
def mindist(x, sample):
    return min(Levenshtein.hamming(s, x) for s in sample)
```


```python
mindist('AAACCCAAA', humansample)
```




    3




```python
%timeit -t mindist('AAACCCAAA', humansample)
```

    39.8 ms ± 1.24 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)



```python
bt = sklearn.neighbors.BallTree(points, metric='hamming')
```


```python
def mindist_sklearn(x, tree):
    d, i = tree.query(map_aatonumber(x).reshape(1, -1))
    return int(d*len(x))
```


```python
mindist_sklearn('AAACCCAAA', bt)
```




    3




```python
%timeit -t mindist_sklearn('AAACCCAAA', bt)
```

    6.2 ms ± 224 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)


## on all 9mers 


```python
mindist('AAACCCAAA', human9)
```




    2




```python
%timeit -t mindist('AAACCCAAA', human9)
```

    4.42 s ± 182 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)



```python
nchunks = 100
```


```python
human9_number = np.asarray([map_aatonumber(h) for h in human9])
```


```python
pointss = np.array_split(human9_number, nchunks)
```


```python
bts = [sklearn.neighbors.BallTree(points, metric='hamming') for points in pointss]
```


```python
def mindist_sklearn_chunked(x, trees):
    d = min(bt.query(map_aatonumber(x).reshape(1, -1))[0] for bt in trees)
    return int(d*len(x))
```


```python
mindist_sklearn_chunked('AAACCCAAA', bts)
```




    2




```python
%timeit -t mindist_sklearn_chunked('AAACCCAAA', bts)
```

    711 ms ± 44.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)



```python
btdist = BallTreeDist(human9, nchunks=nchunks)
```


```python
btdist.mindist('AAACCCAAA')
```




    2




```python
%timeit -t btdist.mindist('AAACCCAAA')
```

    695 ms ± 45.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)



```cython
%%cython -a
from lib import aminoacids
def dist2_cython(x, ref):
    cdef int i, j
    cdef int N = len(x)
    for i in range(N):
        for j in range(i+1, N):
            for aai in aminoacids:
                if aai == x[i]:
                    continue
                si = x[:i]+aai+x[i+1:]
                for aaj in aminoacids:
                    if aaj == x[j]:
                        continue
                    if si[:j]+aaj+si[j+1:] in ref:
                        return True
    return False
```




<!DOCTYPE html>
<!-- Generated by Cython 0.29.6 -->
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Cython: _cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254.pyx</title>
    <style type="text/css">
    
body.cython { font-family: courier; font-size: 12; }

.cython.tag  {  }
.cython.line { margin: 0em }
.cython.code { font-size: 9; color: #444444; display: none; margin: 0px 0px 0px 8px; border-left: 8px none; }

.cython.line .run { background-color: #B0FFB0; }
.cython.line .mis { background-color: #FFB0B0; }
.cython.code.run  { border-left: 8px solid #B0FFB0; }
.cython.code.mis  { border-left: 8px solid #FFB0B0; }

.cython.code .py_c_api  { color: red; }
.cython.code .py_macro_api  { color: #FF7000; }
.cython.code .pyx_c_api  { color: #FF3000; }
.cython.code .pyx_macro_api  { color: #FF7000; }
.cython.code .refnanny  { color: #FFA000; }
.cython.code .trace  { color: #FFA000; }
.cython.code .error_goto  { color: #FFA000; }

.cython.code .coerce  { color: #008000; border: 1px dotted #008000 }
.cython.code .py_attr { color: #FF0000; font-weight: bold; }
.cython.code .c_attr  { color: #0000FF; }
.cython.code .py_call { color: #FF0000; font-weight: bold; }
.cython.code .c_call  { color: #0000FF; }

.cython.score-0 {background-color: #FFFFff;}
.cython.score-1 {background-color: #FFFFe7;}
.cython.score-2 {background-color: #FFFFd4;}
.cython.score-3 {background-color: #FFFFc4;}
.cython.score-4 {background-color: #FFFFb6;}
.cython.score-5 {background-color: #FFFFaa;}
.cython.score-6 {background-color: #FFFF9f;}
.cython.score-7 {background-color: #FFFF96;}
.cython.score-8 {background-color: #FFFF8d;}
.cython.score-9 {background-color: #FFFF86;}
.cython.score-10 {background-color: #FFFF7f;}
.cython.score-11 {background-color: #FFFF79;}
.cython.score-12 {background-color: #FFFF73;}
.cython.score-13 {background-color: #FFFF6e;}
.cython.score-14 {background-color: #FFFF6a;}
.cython.score-15 {background-color: #FFFF66;}
.cython.score-16 {background-color: #FFFF62;}
.cython.score-17 {background-color: #FFFF5e;}
.cython.score-18 {background-color: #FFFF5b;}
.cython.score-19 {background-color: #FFFF57;}
.cython.score-20 {background-color: #FFFF55;}
.cython.score-21 {background-color: #FFFF52;}
.cython.score-22 {background-color: #FFFF4f;}
.cython.score-23 {background-color: #FFFF4d;}
.cython.score-24 {background-color: #FFFF4b;}
.cython.score-25 {background-color: #FFFF48;}
.cython.score-26 {background-color: #FFFF46;}
.cython.score-27 {background-color: #FFFF44;}
.cython.score-28 {background-color: #FFFF43;}
.cython.score-29 {background-color: #FFFF41;}
.cython.score-30 {background-color: #FFFF3f;}
.cython.score-31 {background-color: #FFFF3e;}
.cython.score-32 {background-color: #FFFF3c;}
.cython.score-33 {background-color: #FFFF3b;}
.cython.score-34 {background-color: #FFFF39;}
.cython.score-35 {background-color: #FFFF38;}
.cython.score-36 {background-color: #FFFF37;}
.cython.score-37 {background-color: #FFFF36;}
.cython.score-38 {background-color: #FFFF35;}
.cython.score-39 {background-color: #FFFF34;}
.cython.score-40 {background-color: #FFFF33;}
.cython.score-41 {background-color: #FFFF32;}
.cython.score-42 {background-color: #FFFF31;}
.cython.score-43 {background-color: #FFFF30;}
.cython.score-44 {background-color: #FFFF2f;}
.cython.score-45 {background-color: #FFFF2e;}
.cython.score-46 {background-color: #FFFF2d;}
.cython.score-47 {background-color: #FFFF2c;}
.cython.score-48 {background-color: #FFFF2b;}
.cython.score-49 {background-color: #FFFF2b;}
.cython.score-50 {background-color: #FFFF2a;}
.cython.score-51 {background-color: #FFFF29;}
.cython.score-52 {background-color: #FFFF29;}
.cython.score-53 {background-color: #FFFF28;}
.cython.score-54 {background-color: #FFFF27;}
.cython.score-55 {background-color: #FFFF27;}
.cython.score-56 {background-color: #FFFF26;}
.cython.score-57 {background-color: #FFFF26;}
.cython.score-58 {background-color: #FFFF25;}
.cython.score-59 {background-color: #FFFF24;}
.cython.score-60 {background-color: #FFFF24;}
.cython.score-61 {background-color: #FFFF23;}
.cython.score-62 {background-color: #FFFF23;}
.cython.score-63 {background-color: #FFFF22;}
.cython.score-64 {background-color: #FFFF22;}
.cython.score-65 {background-color: #FFFF22;}
.cython.score-66 {background-color: #FFFF21;}
.cython.score-67 {background-color: #FFFF21;}
.cython.score-68 {background-color: #FFFF20;}
.cython.score-69 {background-color: #FFFF20;}
.cython.score-70 {background-color: #FFFF1f;}
.cython.score-71 {background-color: #FFFF1f;}
.cython.score-72 {background-color: #FFFF1f;}
.cython.score-73 {background-color: #FFFF1e;}
.cython.score-74 {background-color: #FFFF1e;}
.cython.score-75 {background-color: #FFFF1e;}
.cython.score-76 {background-color: #FFFF1d;}
.cython.score-77 {background-color: #FFFF1d;}
.cython.score-78 {background-color: #FFFF1c;}
.cython.score-79 {background-color: #FFFF1c;}
.cython.score-80 {background-color: #FFFF1c;}
.cython.score-81 {background-color: #FFFF1c;}
.cython.score-82 {background-color: #FFFF1b;}
.cython.score-83 {background-color: #FFFF1b;}
.cython.score-84 {background-color: #FFFF1b;}
.cython.score-85 {background-color: #FFFF1a;}
.cython.score-86 {background-color: #FFFF1a;}
.cython.score-87 {background-color: #FFFF1a;}
.cython.score-88 {background-color: #FFFF1a;}
.cython.score-89 {background-color: #FFFF19;}
.cython.score-90 {background-color: #FFFF19;}
.cython.score-91 {background-color: #FFFF19;}
.cython.score-92 {background-color: #FFFF19;}
.cython.score-93 {background-color: #FFFF18;}
.cython.score-94 {background-color: #FFFF18;}
.cython.score-95 {background-color: #FFFF18;}
.cython.score-96 {background-color: #FFFF18;}
.cython.score-97 {background-color: #FFFF17;}
.cython.score-98 {background-color: #FFFF17;}
.cython.score-99 {background-color: #FFFF17;}
.cython.score-100 {background-color: #FFFF17;}
.cython.score-101 {background-color: #FFFF16;}
.cython.score-102 {background-color: #FFFF16;}
.cython.score-103 {background-color: #FFFF16;}
.cython.score-104 {background-color: #FFFF16;}
.cython.score-105 {background-color: #FFFF16;}
.cython.score-106 {background-color: #FFFF15;}
.cython.score-107 {background-color: #FFFF15;}
.cython.score-108 {background-color: #FFFF15;}
.cython.score-109 {background-color: #FFFF15;}
.cython.score-110 {background-color: #FFFF15;}
.cython.score-111 {background-color: #FFFF15;}
.cython.score-112 {background-color: #FFFF14;}
.cython.score-113 {background-color: #FFFF14;}
.cython.score-114 {background-color: #FFFF14;}
.cython.score-115 {background-color: #FFFF14;}
.cython.score-116 {background-color: #FFFF14;}
.cython.score-117 {background-color: #FFFF14;}
.cython.score-118 {background-color: #FFFF13;}
.cython.score-119 {background-color: #FFFF13;}
.cython.score-120 {background-color: #FFFF13;}
.cython.score-121 {background-color: #FFFF13;}
.cython.score-122 {background-color: #FFFF13;}
.cython.score-123 {background-color: #FFFF13;}
.cython.score-124 {background-color: #FFFF13;}
.cython.score-125 {background-color: #FFFF12;}
.cython.score-126 {background-color: #FFFF12;}
.cython.score-127 {background-color: #FFFF12;}
.cython.score-128 {background-color: #FFFF12;}
.cython.score-129 {background-color: #FFFF12;}
.cython.score-130 {background-color: #FFFF12;}
.cython.score-131 {background-color: #FFFF12;}
.cython.score-132 {background-color: #FFFF11;}
.cython.score-133 {background-color: #FFFF11;}
.cython.score-134 {background-color: #FFFF11;}
.cython.score-135 {background-color: #FFFF11;}
.cython.score-136 {background-color: #FFFF11;}
.cython.score-137 {background-color: #FFFF11;}
.cython.score-138 {background-color: #FFFF11;}
.cython.score-139 {background-color: #FFFF11;}
.cython.score-140 {background-color: #FFFF11;}
.cython.score-141 {background-color: #FFFF10;}
.cython.score-142 {background-color: #FFFF10;}
.cython.score-143 {background-color: #FFFF10;}
.cython.score-144 {background-color: #FFFF10;}
.cython.score-145 {background-color: #FFFF10;}
.cython.score-146 {background-color: #FFFF10;}
.cython.score-147 {background-color: #FFFF10;}
.cython.score-148 {background-color: #FFFF10;}
.cython.score-149 {background-color: #FFFF10;}
.cython.score-150 {background-color: #FFFF0f;}
.cython.score-151 {background-color: #FFFF0f;}
.cython.score-152 {background-color: #FFFF0f;}
.cython.score-153 {background-color: #FFFF0f;}
.cython.score-154 {background-color: #FFFF0f;}
.cython.score-155 {background-color: #FFFF0f;}
.cython.score-156 {background-color: #FFFF0f;}
.cython.score-157 {background-color: #FFFF0f;}
.cython.score-158 {background-color: #FFFF0f;}
.cython.score-159 {background-color: #FFFF0f;}
.cython.score-160 {background-color: #FFFF0f;}
.cython.score-161 {background-color: #FFFF0e;}
.cython.score-162 {background-color: #FFFF0e;}
.cython.score-163 {background-color: #FFFF0e;}
.cython.score-164 {background-color: #FFFF0e;}
.cython.score-165 {background-color: #FFFF0e;}
.cython.score-166 {background-color: #FFFF0e;}
.cython.score-167 {background-color: #FFFF0e;}
.cython.score-168 {background-color: #FFFF0e;}
.cython.score-169 {background-color: #FFFF0e;}
.cython.score-170 {background-color: #FFFF0e;}
.cython.score-171 {background-color: #FFFF0e;}
.cython.score-172 {background-color: #FFFF0e;}
.cython.score-173 {background-color: #FFFF0d;}
.cython.score-174 {background-color: #FFFF0d;}
.cython.score-175 {background-color: #FFFF0d;}
.cython.score-176 {background-color: #FFFF0d;}
.cython.score-177 {background-color: #FFFF0d;}
.cython.score-178 {background-color: #FFFF0d;}
.cython.score-179 {background-color: #FFFF0d;}
.cython.score-180 {background-color: #FFFF0d;}
.cython.score-181 {background-color: #FFFF0d;}
.cython.score-182 {background-color: #FFFF0d;}
.cython.score-183 {background-color: #FFFF0d;}
.cython.score-184 {background-color: #FFFF0d;}
.cython.score-185 {background-color: #FFFF0d;}
.cython.score-186 {background-color: #FFFF0d;}
.cython.score-187 {background-color: #FFFF0c;}
.cython.score-188 {background-color: #FFFF0c;}
.cython.score-189 {background-color: #FFFF0c;}
.cython.score-190 {background-color: #FFFF0c;}
.cython.score-191 {background-color: #FFFF0c;}
.cython.score-192 {background-color: #FFFF0c;}
.cython.score-193 {background-color: #FFFF0c;}
.cython.score-194 {background-color: #FFFF0c;}
.cython.score-195 {background-color: #FFFF0c;}
.cython.score-196 {background-color: #FFFF0c;}
.cython.score-197 {background-color: #FFFF0c;}
.cython.score-198 {background-color: #FFFF0c;}
.cython.score-199 {background-color: #FFFF0c;}
.cython.score-200 {background-color: #FFFF0c;}
.cython.score-201 {background-color: #FFFF0c;}
.cython.score-202 {background-color: #FFFF0c;}
.cython.score-203 {background-color: #FFFF0b;}
.cython.score-204 {background-color: #FFFF0b;}
.cython.score-205 {background-color: #FFFF0b;}
.cython.score-206 {background-color: #FFFF0b;}
.cython.score-207 {background-color: #FFFF0b;}
.cython.score-208 {background-color: #FFFF0b;}
.cython.score-209 {background-color: #FFFF0b;}
.cython.score-210 {background-color: #FFFF0b;}
.cython.score-211 {background-color: #FFFF0b;}
.cython.score-212 {background-color: #FFFF0b;}
.cython.score-213 {background-color: #FFFF0b;}
.cython.score-214 {background-color: #FFFF0b;}
.cython.score-215 {background-color: #FFFF0b;}
.cython.score-216 {background-color: #FFFF0b;}
.cython.score-217 {background-color: #FFFF0b;}
.cython.score-218 {background-color: #FFFF0b;}
.cython.score-219 {background-color: #FFFF0b;}
.cython.score-220 {background-color: #FFFF0b;}
.cython.score-221 {background-color: #FFFF0b;}
.cython.score-222 {background-color: #FFFF0a;}
.cython.score-223 {background-color: #FFFF0a;}
.cython.score-224 {background-color: #FFFF0a;}
.cython.score-225 {background-color: #FFFF0a;}
.cython.score-226 {background-color: #FFFF0a;}
.cython.score-227 {background-color: #FFFF0a;}
.cython.score-228 {background-color: #FFFF0a;}
.cython.score-229 {background-color: #FFFF0a;}
.cython.score-230 {background-color: #FFFF0a;}
.cython.score-231 {background-color: #FFFF0a;}
.cython.score-232 {background-color: #FFFF0a;}
.cython.score-233 {background-color: #FFFF0a;}
.cython.score-234 {background-color: #FFFF0a;}
.cython.score-235 {background-color: #FFFF0a;}
.cython.score-236 {background-color: #FFFF0a;}
.cython.score-237 {background-color: #FFFF0a;}
.cython.score-238 {background-color: #FFFF0a;}
.cython.score-239 {background-color: #FFFF0a;}
.cython.score-240 {background-color: #FFFF0a;}
.cython.score-241 {background-color: #FFFF0a;}
.cython.score-242 {background-color: #FFFF0a;}
.cython.score-243 {background-color: #FFFF0a;}
.cython.score-244 {background-color: #FFFF0a;}
.cython.score-245 {background-color: #FFFF0a;}
.cython.score-246 {background-color: #FFFF09;}
.cython.score-247 {background-color: #FFFF09;}
.cython.score-248 {background-color: #FFFF09;}
.cython.score-249 {background-color: #FFFF09;}
.cython.score-250 {background-color: #FFFF09;}
.cython.score-251 {background-color: #FFFF09;}
.cython.score-252 {background-color: #FFFF09;}
.cython.score-253 {background-color: #FFFF09;}
.cython.score-254 {background-color: #FFFF09;}
.cython .hll { background-color: #ffffcc }
.cython  { background: #f8f8f8; }
.cython .c { color: #408080; font-style: italic } /* Comment */
.cython .err { border: 1px solid #FF0000 } /* Error */
.cython .k { color: #008000; font-weight: bold } /* Keyword */
.cython .o { color: #666666 } /* Operator */
.cython .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.cython .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.cython .cp { color: #BC7A00 } /* Comment.Preproc */
.cython .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.cython .c1 { color: #408080; font-style: italic } /* Comment.Single */
.cython .cs { color: #408080; font-style: italic } /* Comment.Special */
.cython .gd { color: #A00000 } /* Generic.Deleted */
.cython .ge { font-style: italic } /* Generic.Emph */
.cython .gr { color: #FF0000 } /* Generic.Error */
.cython .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.cython .gi { color: #00A000 } /* Generic.Inserted */
.cython .go { color: #888888 } /* Generic.Output */
.cython .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.cython .gs { font-weight: bold } /* Generic.Strong */
.cython .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.cython .gt { color: #0044DD } /* Generic.Traceback */
.cython .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.cython .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.cython .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.cython .kp { color: #008000 } /* Keyword.Pseudo */
.cython .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.cython .kt { color: #B00040 } /* Keyword.Type */
.cython .m { color: #666666 } /* Literal.Number */
.cython .s { color: #BA2121 } /* Literal.String */
.cython .na { color: #7D9029 } /* Name.Attribute */
.cython .nb { color: #008000 } /* Name.Builtin */
.cython .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.cython .no { color: #880000 } /* Name.Constant */
.cython .nd { color: #AA22FF } /* Name.Decorator */
.cython .ni { color: #999999; font-weight: bold } /* Name.Entity */
.cython .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.cython .nf { color: #0000FF } /* Name.Function */
.cython .nl { color: #A0A000 } /* Name.Label */
.cython .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.cython .nt { color: #008000; font-weight: bold } /* Name.Tag */
.cython .nv { color: #19177C } /* Name.Variable */
.cython .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.cython .w { color: #bbbbbb } /* Text.Whitespace */
.cython .mb { color: #666666 } /* Literal.Number.Bin */
.cython .mf { color: #666666 } /* Literal.Number.Float */
.cython .mh { color: #666666 } /* Literal.Number.Hex */
.cython .mi { color: #666666 } /* Literal.Number.Integer */
.cython .mo { color: #666666 } /* Literal.Number.Oct */
.cython .sa { color: #BA2121 } /* Literal.String.Affix */
.cython .sb { color: #BA2121 } /* Literal.String.Backtick */
.cython .sc { color: #BA2121 } /* Literal.String.Char */
.cython .dl { color: #BA2121 } /* Literal.String.Delimiter */
.cython .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.cython .s2 { color: #BA2121 } /* Literal.String.Double */
.cython .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.cython .sh { color: #BA2121 } /* Literal.String.Heredoc */
.cython .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.cython .sx { color: #008000 } /* Literal.String.Other */
.cython .sr { color: #BB6688 } /* Literal.String.Regex */
.cython .s1 { color: #BA2121 } /* Literal.String.Single */
.cython .ss { color: #19177C } /* Literal.String.Symbol */
.cython .bp { color: #008000 } /* Name.Builtin.Pseudo */
.cython .fm { color: #0000FF } /* Name.Function.Magic */
.cython .vc { color: #19177C } /* Name.Variable.Class */
.cython .vg { color: #19177C } /* Name.Variable.Global */
.cython .vi { color: #19177C } /* Name.Variable.Instance */
.cython .vm { color: #19177C } /* Name.Variable.Magic */
.cython .il { color: #666666 } /* Literal.Number.Integer.Long */
    </style>
</head>
<body class="cython">
<p><span style="border-bottom: solid 1px grey;">Generated by Cython 0.29.6</span></p>
<p>
    <span style="background-color: #FFFF00">Yellow lines</span> hint at Python interaction.<br />
    Click on a line that starts with a "<code>+</code>" to see the C code that Cython generated for it.
</p>
<div class="cython"><pre class="cython line score-19" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">01</span>: <span class="k">from</span> <span class="nn">lib</span> <span class="k">import</span> <span class="n">aminoacids</span></pre>
<pre class='cython code score-19 '>  __pyx_t_1 = <span class='py_c_api'>PyList_New</span>(1);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_n_s_aminoacids);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_n_s_aminoacids);
  <span class='py_macro_api'>PyList_SET_ITEM</span>(__pyx_t_1, 0, __pyx_n_s_aminoacids);
  __pyx_t_2 = <span class='pyx_c_api'>__Pyx_Import</span>(__pyx_n_s_lib, __pyx_t_1, 0);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  __pyx_t_1 = <span class='pyx_c_api'>__Pyx_ImportFrom</span>(__pyx_t_2, __pyx_n_s_aminoacids);<span class='error_goto'> if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_1);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_aminoacids, __pyx_t_1) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 1, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_1); __pyx_t_1 = 0;
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-45" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">02</span>: <span class="k">def</span> <span class="nf">dist2_cython</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span></pre>
<pre class='cython code score-45 '>/* Python wrapper */
static PyObject *__pyx_pw_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_1dist2_cython(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
static PyMethodDef __pyx_mdef_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_1dist2_cython = {"dist2_cython", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_1dist2_cython, METH_VARARGS|METH_KEYWORDS, 0};
static PyObject *__pyx_pw_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_1dist2_cython(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
  PyObject *__pyx_v_x = 0;
  PyObject *__pyx_v_ref = 0;
  PyObject *__pyx_r = 0;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("dist2_cython (wrapper)", 0);
  {
    static PyObject **__pyx_pyargnames[] = {&amp;__pyx_n_s_x,&amp;__pyx_n_s_ref,0};
    PyObject* values[2] = {0,0};
    if (unlikely(__pyx_kwds)) {
      Py_ssize_t kw_args;
      const Py_ssize_t pos_args = <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args);
      switch (pos_args) {
        case  2: values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
        CYTHON_FALLTHROUGH;
        case  1: values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
        CYTHON_FALLTHROUGH;
        case  0: break;
        default: goto __pyx_L5_argtuple_error;
      }
      kw_args = <span class='py_c_api'>PyDict_Size</span>(__pyx_kwds);
      switch (pos_args) {
        case  0:
        if (likely((values[0] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_x)) != 0)) kw_args--;
        else goto __pyx_L5_argtuple_error;
        CYTHON_FALLTHROUGH;
        case  1:
        if (likely((values[1] = <span class='pyx_c_api'>__Pyx_PyDict_GetItemStr</span>(__pyx_kwds, __pyx_n_s_ref)) != 0)) kw_args--;
        else {
          <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("dist2_cython", 1, 2, 2, 1); <span class='error_goto'>__PYX_ERR(0, 2, __pyx_L3_error)</span>
        }
      }
      if (unlikely(kw_args &gt; 0)) {
        if (unlikely(<span class='pyx_c_api'>__Pyx_ParseOptionalKeywords</span>(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "dist2_cython") &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 2, __pyx_L3_error)</span>
      }
    } else if (<span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args) != 2) {
      goto __pyx_L5_argtuple_error;
    } else {
      values[0] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 0);
      values[1] = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_args, 1);
    }
    __pyx_v_x = values[0];
    __pyx_v_ref = values[1];
  }
  goto __pyx_L4_argument_unpacking_done;
  __pyx_L5_argtuple_error:;
  <span class='pyx_c_api'>__Pyx_RaiseArgtupleInvalid</span>("dist2_cython", 1, 2, 2, <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_args)); <span class='error_goto'>__PYX_ERR(0, 2, __pyx_L3_error)</span>
  __pyx_L3_error:;
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254.dist2_cython", __pyx_clineno, __pyx_lineno, __pyx_filename);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return NULL;
  __pyx_L4_argument_unpacking_done:;
  __pyx_r = __pyx_pf_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_dist2_cython(__pyx_self, __pyx_v_x, __pyx_v_ref);

  /* function exit code */
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}

static PyObject *__pyx_pf_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_dist2_cython(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_x, PyObject *__pyx_v_ref) {
  int __pyx_v_i;
  int __pyx_v_j;
  int __pyx_v_N;
  PyObject *__pyx_v_aai = NULL;
  PyObject *__pyx_v_si = NULL;
  PyObject *__pyx_v_aaj = NULL;
  PyObject *__pyx_r = NULL;
  <span class='refnanny'>__Pyx_RefNannyDeclarations</span>
  <span class='refnanny'>__Pyx_RefNannySetupContext</span>("dist2_cython", 0);
/* … */
  /* function exit code */
  __pyx_L1_error:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_8);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_9);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_11);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_13);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_t_16);
  <span class='pyx_c_api'>__Pyx_AddTraceback</span>("_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254.dist2_cython", __pyx_clineno, __pyx_lineno, __pyx_filename);
  __pyx_r = NULL;
  __pyx_L0:;
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_aai);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_si);
  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_v_aaj);
  <span class='refnanny'>__Pyx_XGIVEREF</span>(__pyx_r);
  <span class='refnanny'>__Pyx_RefNannyFinishContext</span>();
  return __pyx_r;
}
/* … */
  __pyx_tuple_ = <span class='py_c_api'>PyTuple_Pack</span>(8, __pyx_n_s_x, __pyx_n_s_ref, __pyx_n_s_i, __pyx_n_s_j, __pyx_n_s_N, __pyx_n_s_aai, __pyx_n_s_si, __pyx_n_s_aaj);<span class='error_goto'> if (unlikely(!__pyx_tuple_)) __PYX_ERR(0, 2, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_tuple_);
  <span class='refnanny'>__Pyx_GIVEREF</span>(__pyx_tuple_);
/* … */
  __pyx_t_2 = PyCFunction_NewEx(&amp;__pyx_mdef_46_cython_magic_c72e9eabdf6c6ab0bbe40d8d2f7c4254_1dist2_cython, NULL, __pyx_n_s_cython_magic_c72e9eabdf6c6ab0bb);<span class='error_goto'> if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 2, __pyx_L1_error)</span>
  <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_2);
  if (<span class='py_c_api'>PyDict_SetItem</span>(__pyx_d, __pyx_n_s_dist2_cython, __pyx_t_2) &lt; 0) <span class='error_goto'>__PYX_ERR(0, 2, __pyx_L1_error)</span>
  <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_2); __pyx_t_2 = 0;
</pre><pre class="cython line score-0">&#xA0;<span class="">03</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span><span class="p">,</span> <span class="nf">j</span></pre>
<pre class="cython line score-5" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">04</span>:     <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre>
<pre class='cython code score-5 '>  __pyx_t_1 = <span class='py_c_api'>PyObject_Length</span>(__pyx_v_x);<span class='error_goto'> if (unlikely(__pyx_t_1 == ((Py_ssize_t)-1))) __PYX_ERR(0, 4, __pyx_L1_error)</span>
  __pyx_v_N = __pyx_t_1;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">05</span>:     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>  __pyx_t_2 = __pyx_v_N;
  __pyx_t_3 = __pyx_t_2;
  for (__pyx_t_4 = 0; __pyx_t_4 &lt; __pyx_t_3; __pyx_t_4+=1) {
    __pyx_v_i = __pyx_t_4;
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">06</span>:         <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span></pre>
<pre class='cython code score-0 '>    __pyx_t_5 = __pyx_v_N;
    __pyx_t_6 = __pyx_t_5;
    for (__pyx_t_7 = (__pyx_v_i + 1); __pyx_t_7 &lt; __pyx_t_6; __pyx_t_7+=1) {
      __pyx_v_j = __pyx_t_7;
</pre><pre class="cython line score-46" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">07</span>:             <span class="k">for</span> <span class="n">aai</span> <span class="ow">in</span> <span class="n">aminoacids</span><span class="p">:</span></pre>
<pre class='cython code score-46 '>      <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_8, __pyx_n_s_aminoacids);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 7, __pyx_L1_error)</span>
      <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
      if (likely(<span class='py_c_api'>PyList_CheckExact</span>(__pyx_t_8)) || <span class='py_c_api'>PyTuple_CheckExact</span>(__pyx_t_8)) {
        __pyx_t_9 = __pyx_t_8; <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_9); __pyx_t_1 = 0;
        __pyx_t_10 = NULL;
      } else {
        __pyx_t_1 = -1; __pyx_t_9 = <span class='py_c_api'>PyObject_GetIter</span>(__pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 7, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_9);
        __pyx_t_10 = Py_TYPE(__pyx_t_9)-&gt;tp_iternext;<span class='error_goto'> if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 7, __pyx_L1_error)</span>
      }
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
      for (;;) {
        if (likely(!__pyx_t_10)) {
          if (likely(<span class='py_c_api'>PyList_CheckExact</span>(__pyx_t_9))) {
            if (__pyx_t_1 &gt;= <span class='py_macro_api'>PyList_GET_SIZE</span>(__pyx_t_9)) break;
            #if CYTHON_ASSUME_SAFE_MACROS &amp;&amp; !CYTHON_AVOID_BORROWED_REFS
            __pyx_t_8 = <span class='py_macro_api'>PyList_GET_ITEM</span>(__pyx_t_9, __pyx_t_1); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_8); __pyx_t_1++; if (unlikely(0 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 7, __pyx_L1_error)</span>
            #else
            __pyx_t_8 = <span class='py_macro_api'>PySequence_ITEM</span>(__pyx_t_9, __pyx_t_1); __pyx_t_1++;<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 7, __pyx_L1_error)</span>
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
            #endif
          } else {
            if (__pyx_t_1 &gt;= <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_t_9)) break;
            #if CYTHON_ASSUME_SAFE_MACROS &amp;&amp; !CYTHON_AVOID_BORROWED_REFS
            __pyx_t_8 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_t_9, __pyx_t_1); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_8); __pyx_t_1++; if (unlikely(0 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 7, __pyx_L1_error)</span>
            #else
            __pyx_t_8 = <span class='py_macro_api'>PySequence_ITEM</span>(__pyx_t_9, __pyx_t_1); __pyx_t_1++;<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 7, __pyx_L1_error)</span>
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
            #endif
          }
        } else {
          __pyx_t_8 = __pyx_t_10(__pyx_t_9);
          if (unlikely(!__pyx_t_8)) {
            PyObject* exc_type = <span class='py_c_api'>PyErr_Occurred</span>();
            if (exc_type) {
              if (likely(<span class='pyx_c_api'>__Pyx_PyErr_GivenExceptionMatches</span>(exc_type, PyExc_StopIteration))) <span class='py_c_api'>PyErr_Clear</span>();
              else <span class='error_goto'>__PYX_ERR(0, 7, __pyx_L1_error)</span>
            }
            break;
          }
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
        }
        <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_aai, __pyx_t_8);
        __pyx_t_8 = 0;
/* … */
        __pyx_L7_continue:;
      }
      <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
    }
  }
</pre><pre class="cython line score-11" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">08</span>:                 <span class="k">if</span> <span class="n">aai</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span></pre>
<pre class='cython code score-11 '>        __pyx_t_8 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_v_x, __pyx_v_i, int, 1, __Pyx_PyInt_From_int, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 8, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
        __pyx_t_11 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_v_aai, __pyx_t_8, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 8, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
        __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_11); if (unlikely(__pyx_t_12 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 8, __pyx_L1_error)</span>
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
        if (__pyx_t_12) {
/* … */
        }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">09</span>:                     <span class="k">continue</span></pre>
<pre class='cython code score-0 '>          goto __pyx_L7_continue;
</pre><pre class="cython line score-18" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">10</span>:                 <span class="n">si</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">aai</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mf">1</span><span class="p">:]</span></pre>
<pre class='cython code score-18 '>        __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_GetSlice</span>(__pyx_v_x, 0, __pyx_v_i, NULL, NULL, NULL, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 10, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_11);
        __pyx_t_8 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_11, __pyx_v_aai);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 10, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
        __pyx_t_11 = <span class='pyx_c_api'>__Pyx_PyObject_GetSlice</span>(__pyx_v_x, (__pyx_v_i + 1), 0, NULL, NULL, NULL, 1, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 10, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_11);
        __pyx_t_13 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_8, __pyx_t_11);<span class='error_goto'> if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 10, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
        <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_si, __pyx_t_13);
        __pyx_t_13 = 0;
</pre><pre class="cython line score-46" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">11</span>:                 <span class="k">for</span> <span class="n">aaj</span> <span class="ow">in</span> <span class="n">aminoacids</span><span class="p">:</span></pre>
<pre class='cython code score-46 '>        <span class='pyx_c_api'>__Pyx_GetModuleGlobalName</span>(__pyx_t_13, __pyx_n_s_aminoacids);<span class='error_goto'> if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
        <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
        if (likely(<span class='py_c_api'>PyList_CheckExact</span>(__pyx_t_13)) || <span class='py_c_api'>PyTuple_CheckExact</span>(__pyx_t_13)) {
          __pyx_t_11 = __pyx_t_13; <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_11); __pyx_t_14 = 0;
          __pyx_t_15 = NULL;
        } else {
          __pyx_t_14 = -1; __pyx_t_11 = <span class='py_c_api'>PyObject_GetIter</span>(__pyx_t_13);<span class='error_goto'> if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_11);
          __pyx_t_15 = Py_TYPE(__pyx_t_11)-&gt;tp_iternext;<span class='error_goto'> if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
        }
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_13); __pyx_t_13 = 0;
        for (;;) {
          if (likely(!__pyx_t_15)) {
            if (likely(<span class='py_c_api'>PyList_CheckExact</span>(__pyx_t_11))) {
              if (__pyx_t_14 &gt;= <span class='py_macro_api'>PyList_GET_SIZE</span>(__pyx_t_11)) break;
              #if CYTHON_ASSUME_SAFE_MACROS &amp;&amp; !CYTHON_AVOID_BORROWED_REFS
              __pyx_t_13 = <span class='py_macro_api'>PyList_GET_ITEM</span>(__pyx_t_11, __pyx_t_14); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_13); __pyx_t_14++; if (unlikely(0 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 11, __pyx_L1_error)</span>
              #else
              __pyx_t_13 = <span class='py_macro_api'>PySequence_ITEM</span>(__pyx_t_11, __pyx_t_14); __pyx_t_14++;<span class='error_goto'> if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
              <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
              #endif
            } else {
              if (__pyx_t_14 &gt;= <span class='py_macro_api'>PyTuple_GET_SIZE</span>(__pyx_t_11)) break;
              #if CYTHON_ASSUME_SAFE_MACROS &amp;&amp; !CYTHON_AVOID_BORROWED_REFS
              __pyx_t_13 = <span class='py_macro_api'>PyTuple_GET_ITEM</span>(__pyx_t_11, __pyx_t_14); <span class='pyx_macro_api'>__Pyx_INCREF</span>(__pyx_t_13); __pyx_t_14++; if (unlikely(0 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 11, __pyx_L1_error)</span>
              #else
              __pyx_t_13 = <span class='py_macro_api'>PySequence_ITEM</span>(__pyx_t_11, __pyx_t_14); __pyx_t_14++;<span class='error_goto'> if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 11, __pyx_L1_error)</span>
              <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
              #endif
            }
          } else {
            __pyx_t_13 = __pyx_t_15(__pyx_t_11);
            if (unlikely(!__pyx_t_13)) {
              PyObject* exc_type = <span class='py_c_api'>PyErr_Occurred</span>();
              if (exc_type) {
                if (likely(<span class='pyx_c_api'>__Pyx_PyErr_GivenExceptionMatches</span>(exc_type, PyExc_StopIteration))) <span class='py_c_api'>PyErr_Clear</span>();
                else <span class='error_goto'>__PYX_ERR(0, 11, __pyx_L1_error)</span>
              }
              break;
            }
            <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
          }
          <span class='pyx_macro_api'>__Pyx_XDECREF_SET</span>(__pyx_v_aaj, __pyx_t_13);
          __pyx_t_13 = 0;
/* … */
          __pyx_L10_continue:;
        }
        <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
</pre><pre class="cython line score-11" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">12</span>:                     <span class="k">if</span> <span class="n">aaj</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span></pre>
<pre class='cython code score-11 '>          __pyx_t_13 = <span class='pyx_c_api'>__Pyx_GetItemInt</span>(__pyx_v_x, __pyx_v_j, int, 1, __Pyx_PyInt_From_int, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 12, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
          __pyx_t_8 = <span class='py_c_api'>PyObject_RichCompare</span>(__pyx_v_aaj, __pyx_t_13, Py_EQ); <span class='refnanny'>__Pyx_XGOTREF</span>(__pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 12, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_13); __pyx_t_13 = 0;
          __pyx_t_12 = <span class='pyx_c_api'>__Pyx_PyObject_IsTrue</span>(__pyx_t_8); if (unlikely(__pyx_t_12 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 12, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
          if (__pyx_t_12) {
/* … */
          }
</pre><pre class="cython line score-0" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">13</span>:                         <span class="k">continue</span></pre>
<pre class='cython code score-0 '>            goto __pyx_L10_continue;
</pre><pre class="cython line score-20" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">14</span>:                     <span class="k">if</span> <span class="n">si</span><span class="p">[:</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">aaj</span><span class="o">+</span><span class="n">si</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mf">1</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">ref</span><span class="p">:</span></pre>
<pre class='cython code score-20 '>          __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetSlice</span>(__pyx_v_si, 0, __pyx_v_j, NULL, NULL, NULL, 0, 1, 1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 14, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
          __pyx_t_13 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_8, __pyx_v_aaj);<span class='error_goto'> if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 14, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_13);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
          __pyx_t_8 = <span class='pyx_c_api'>__Pyx_PyObject_GetSlice</span>(__pyx_v_si, (__pyx_v_j + 1), 0, NULL, NULL, NULL, 1, 0, 1);<span class='error_goto'> if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 14, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_8);
          __pyx_t_16 = <span class='py_c_api'>PyNumber_Add</span>(__pyx_t_13, __pyx_t_8);<span class='error_goto'> if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 14, __pyx_L1_error)</span>
          <span class='refnanny'>__Pyx_GOTREF</span>(__pyx_t_16);
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_13); __pyx_t_13 = 0;
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_8); __pyx_t_8 = 0;
          __pyx_t_12 = (<span class='pyx_c_api'>__Pyx_PySequence_ContainsTF</span>(__pyx_t_16, __pyx_v_ref, Py_EQ)); if (unlikely(__pyx_t_12 &lt; 0)) <span class='error_goto'>__PYX_ERR(0, 14, __pyx_L1_error)</span>
          <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_16); __pyx_t_16 = 0;
          __pyx_t_17 = (__pyx_t_12 != 0);
          if (__pyx_t_17) {
/* … */
          }
</pre><pre class="cython line score-4" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">15</span>:                         <span class="k">return</span> <span class="bp">True</span></pre>
<pre class='cython code score-4 '>            <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
            <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_True);
            __pyx_r = Py_True;
            <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_9); __pyx_t_9 = 0;
            <span class='pyx_macro_api'>__Pyx_DECREF</span>(__pyx_t_11); __pyx_t_11 = 0;
            goto __pyx_L0;
</pre><pre class="cython line score-2" onclick="(function(s){s.display=s.display==='block'?'none':'block'})(this.nextElementSibling.style)">+<span class="">16</span>:     <span class="k">return</span> <span class="bp">False</span></pre>
<pre class='cython code score-2 '>  <span class='pyx_macro_api'>__Pyx_XDECREF</span>(__pyx_r);
  <span class='pyx_macro_api'>__Pyx_INCREF</span>(Py_False);
  __pyx_r = Py_False;
  goto __pyx_L0;
</pre></div></body></html>




```python
%%timeit -t
dist2('LFLEILVKE', human9)
```

    389 µs ± 2.48 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)



```python
%%timeit -t
dist2_cython('LFLEILVKE', human9)
```

    428 µs ± 38.8 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)



```python

```
#### nndist.py

```python
import numpy as np
import pandas as pd
from scipy.stats import entropy
import scipy.stats
from scipy.stats import poisson
import seaborn as sns
import sklearn.neighbors
import matplotlib.pyplot as plt

import Levenshtein

import sys
sys.path.append('..')
from lib import *

plt.style.use('../peptidome.mplstyle')

counter9 = count_kmers_proteome(human, k, clean=True)
human9 = set(counter9)
Nhuman = len(human9)

selfset = human9

def distance_distribution(sample, selfset):
    d0 = [x in selfset for x in sample]
    count0 = np.sum(d0)
    d1 = np.array([dist1(x, selfset) for x in sample])
    count1 = np.sum(d1)
    d2 = np.array([dist2(x, selfset) for x in sample]) & (~d1)
    count2 = np.sum(d2)
    ns = np.array([count0, count1, count2, len(sample)-count0-count1-count2])
    return ns

 = count_kmers_proteome(datadir + 'cancer/pb1ufo.fasta.gz')

```
