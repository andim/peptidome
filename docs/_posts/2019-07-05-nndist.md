---
layout: post
title: Distributions of nearest neighbor distances
---

Is the finiteness of the self proteome important?

{% include post-image-gallery.html filter="nndist/" %}

### Code 
#### nn_analysis.ipynb



```python
import numpy as np
import pandas as pd
from scipy.stats import entropy
import scipy.stats
import seaborn as sns
import sklearn.neighbors
import matplotlib.pyplot as plt
%matplotlib inline

import Levenshtein

import sys
sys.path.append('..')

from lib import *
```


```python
df_t = load_iedb_tcellepitopes(human_only=True, positive_only=True)
```


```python
k = 9
counter9 = count_kmers_proteome(human, k, clean=True)
```


```python
human9 = set(counter9)
```


```python
# no human epitopes
mask = ~df_t['Epitope', 'Parent Species'].str.contains('Homo sapiens', na=False)
# no epitopes of unknown provenance
mask &= ~df_t['Epitope', 'Parent Species'].isna()
# only epitopes of length 9
mask &= df_t['Epitope', 'Description'].apply(len)==9
# only infectious disease epitopes
mask &= df_t['1st in vivo Process', 'Process Type'] == 'Occurrence of infectious disease'
d = df_t[mask]
```


```python
#d['1st in vivo Process', 'Process Type'].value_counts()
```


```python
d0 = d[d['Epitope', 'Description'].apply(lambda x: x in human9)]
d0.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead tr th {
        text-align: left;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr>
      <th></th>
      <th colspan="9" halign="left">Reference</th>
      <th>Epitope</th>
      <th>...</th>
      <th colspan="9" halign="left">Assay Antigen</th>
      <th>Assay Comments</th>
    </tr>
    <tr>
      <th></th>
      <th>Assay IRI</th>
      <th>Reference IRI</th>
      <th>Type</th>
      <th>PubMed ID</th>
      <th>Authors</th>
      <th>Journal</th>
      <th>Date</th>
      <th>Title</th>
      <th>Submission ID</th>
      <th>Epitope IRI</th>
      <th>...</th>
      <th>Non-peptidic Antigen IRI</th>
      <th>Antigen Source Molecule Name</th>
      <th>Antigen Source Molecule IRI</th>
      <th>Protein Parent Name</th>
      <th>Protein Parent IRI</th>
      <th>Antigen Organism Name</th>
      <th>Antigen Organism IRI</th>
      <th>Organism Species Name</th>
      <th>Organism Species IRI</th>
      <th>Assay Comments</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>79301</th>
      <td>http://www.iedb.org/assay/1472651</td>
      <td>http://www.iedb.org/reference/1006541</td>
      <td>Literature</td>
      <td>7520213.0</td>
      <td>S S Witkin; J Jeremias; M Toth; W J Ledger</td>
      <td>Am J Obstet Gynecol</td>
      <td>1994</td>
      <td>Proliferative response to conserved epitopes o...</td>
      <td>NaN</td>
      <td>http://www.iedb.org/epitope/5394</td>
      <td>...</td>
      <td>NaN</td>
      <td>groE</td>
      <td>http://www.ncbi.nlm.nih.gov/protein/AAA23128.1</td>
      <td>60 kDa chaperonin</td>
      <td>http://www.uniprot.org/uniprot/P0C0Z7</td>
      <td>Chlamydia trachomatis</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_813</td>
      <td>Chlamydia trachomatis</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_813</td>
      <td>PBMC from four of ten patients experiencing tw...</td>
    </tr>
    <tr>
      <th>116420</th>
      <td>http://www.iedb.org/assay/1664514</td>
      <td>http://www.iedb.org/reference/1007092</td>
      <td>Literature</td>
      <td>1281825.0</td>
      <td>J M Davies; S Sonoda; S Yashiki; M Osame; P R ...</td>
      <td>J Neuroimmunol</td>
      <td>1992</td>
      <td>Mimicry between HTLV-I and myelin basic protei...</td>
      <td>NaN</td>
      <td>http://www.iedb.org/epitope/113416</td>
      <td>...</td>
      <td>NaN</td>
      <td>Myelin basic protein</td>
      <td>https://ontology.iedb.org/ontology/ONTIE_0002407</td>
      <td>Myelin basic protein</td>
      <td>http://www.uniprot.org/uniprot/P25188</td>
      <td>Cavia porcellus</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_10141</td>
      <td>Cavia porcellus</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_10141</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>279349</th>
      <td>http://www.iedb.org/assay/2642070</td>
      <td>http://www.iedb.org/reference/1029824</td>
      <td>Literature</td>
      <td>26771180.0</td>
      <td>Ikbel Naouar; Thouraya Boussoffara; Mehdi Chen...</td>
      <td>PLoS One</td>
      <td>2016</td>
      <td>Prediction of T Cell Epitopes from Leishmania ...</td>
      <td>NaN</td>
      <td>http://www.iedb.org/epitope/492663</td>
      <td>...</td>
      <td>NaN</td>
      <td>putative proteasome regulatory ATPase subunit 2</td>
      <td>http://www.ncbi.nlm.nih.gov/protein/XP_0016818...</td>
      <td>Putative proteasome regulatory ATPase subunit 2</td>
      <td>http://www.uniprot.org/uniprot/Q4QG45</td>
      <td>Leishmania major</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_5664</td>
      <td>Leishmania major</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_5664</td>
      <td>Variable levels of GrB were detected in HLA-A*...</td>
    </tr>
    <tr>
      <th>279351</th>
      <td>http://www.iedb.org/assay/2642072</td>
      <td>http://www.iedb.org/reference/1029824</td>
      <td>Literature</td>
      <td>26771180.0</td>
      <td>Ikbel Naouar; Thouraya Boussoffara; Mehdi Chen...</td>
      <td>PLoS One</td>
      <td>2016</td>
      <td>Prediction of T Cell Epitopes from Leishmania ...</td>
      <td>NaN</td>
      <td>http://www.iedb.org/epitope/490102</td>
      <td>...</td>
      <td>NaN</td>
      <td>putative proteasome regulatory ATPase subunit 2</td>
      <td>http://www.ncbi.nlm.nih.gov/protein/XP_0016818...</td>
      <td>Putative proteasome regulatory ATPase subunit 2</td>
      <td>http://www.uniprot.org/uniprot/Q4QG45</td>
      <td>Leishmania major</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_5664</td>
      <td>Leishmania major</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_5664</td>
      <td>Variable levels of GrB were detected in HLA-A*...</td>
    </tr>
    <tr>
      <th>338722</th>
      <td>http://www.iedb.org/assay/3925457</td>
      <td>http://www.iedb.org/reference/1033211</td>
      <td>Literature</td>
      <td>29709038.0</td>
      <td>Nicolas Jouand; C&amp;eacute;line Bressollette-Bod...</td>
      <td>PLoS Pathog</td>
      <td>2018</td>
      <td>HCMV triggers frequent and persistent UL40-spe...</td>
      <td>NaN</td>
      <td>http://www.iedb.org/epitope/95972</td>
      <td>...</td>
      <td>NaN</td>
      <td>membrane glycoprotein UL40</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>Human betaherpesvirus 5</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_10359</td>
      <td>Human betaherpesvirus 5</td>
      <td>http://purl.obolibrary.org/obo/NCBITaxon_10359</td>
      <td>HLA-E/UL40 enriched populations from HCMV+ kid...</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 141 columns</p>
</div>




```python
d0['Epitope', 'Parent Species'].unique()
```




    array(['Chlamydia trachomatis', 'Cavia porcellus', 'Leishmania major',
           'Human betaherpesvirus 5'], dtype=object)




```python
counter_to_df(counter9)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>seq</th>
      <th>freq</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MGAPLLSPG</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>1</th>
      <td>GAPLLSPGW</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>2</th>
      <td>APLLSPGWG</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>3</th>
      <td>PLLSPGWGA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>4</th>
      <td>LLSPGWGAG</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>5</th>
      <td>LSPGWGAGA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>6</th>
      <td>SPGWGAGAA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>7</th>
      <td>PGWGAGAAG</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>8</th>
      <td>GWGAGAAGR</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>9</th>
      <td>WGAGAAGRR</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>10</th>
      <td>GAGAAGRRW</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>11</th>
      <td>AGAAGRRWW</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>12</th>
      <td>GAAGRRWWM</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>13</th>
      <td>AAGRRWWML</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>14</th>
      <td>AGRRWWMLL</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>15</th>
      <td>GRRWWMLLA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>16</th>
      <td>RRWWMLLAP</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>17</th>
      <td>RWWMLLAPL</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>18</th>
      <td>WWMLLAPLL</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>19</th>
      <td>WMLLAPLLP</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>20</th>
      <td>MLLAPLLPA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>21</th>
      <td>LLAPLLPAL</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>22</th>
      <td>LAPLLPALL</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>23</th>
      <td>APLLPALLL</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>24</th>
      <td>PLLPALLLV</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>25</th>
      <td>LLPALLLVR</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>26</th>
      <td>LPALLLVRP</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>27</th>
      <td>PALLLVRPA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>28</th>
      <td>ALLLVRPAG</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>29</th>
      <td>LLLVRPAGA</td>
      <td>1.762206e-07</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>10401727</th>
      <td>NPFYTLQKP</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401728</th>
      <td>PFYTLQKPT</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401729</th>
      <td>FYTLQKPTC</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401730</th>
      <td>YTLQKPTCG</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401731</th>
      <td>TLQKPTCGY</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401732</th>
      <td>LQKPTCGYL</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401733</th>
      <td>QKPTCGYLY</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401734</th>
      <td>KPTCGYLYR</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401735</th>
      <td>PTCGYLYRR</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401736</th>
      <td>TCGYLYRRD</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401737</th>
      <td>CGYLYRRDT</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401738</th>
      <td>GYLYRRDTD</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401739</th>
      <td>YLYRRDTDH</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401740</th>
      <td>LYRRDTDHT</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401741</th>
      <td>YRRDTDHTR</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401742</th>
      <td>RRDTDHTRK</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401743</th>
      <td>RDTDHTRKR</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401744</th>
      <td>DTDHTRKRF</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401745</th>
      <td>TDHTRKRFD</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401746</th>
      <td>DHTRKRFDV</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401747</th>
      <td>HTRKRFDVP</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401748</th>
      <td>TRKRFDVPP</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401749</th>
      <td>RKRFDVPPA</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401750</th>
      <td>KRFDVPPAN</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401751</th>
      <td>RFDVPPANL</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401752</th>
      <td>FDVPPANLV</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401753</th>
      <td>DVPPANLVL</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401754</th>
      <td>VPPANLVLW</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401755</th>
      <td>PPANLVLWR</td>
      <td>8.811031e-08</td>
    </tr>
    <tr>
      <th>10401756</th>
      <td>PANLVLWRS</td>
      <td>8.811031e-08</td>
    </tr>
  </tbody>
</table>
<p>10401757 rows × 2 columns</p>
</div>




```python
p = len(human9)/20**9
d0.shape[0], p*d.shape[0]
```




    (8, 0.08341721531640625)




```python
def dist1(x):
    for i in range(len(x)):
        for aa in aminoacids:
            if aa == x[i]:
                continue
            if x[:i]+aa+x[i+1:] in human9:
                return True
    return False
d1 = d[d['Epitope', 'Description'].apply(dist1)]
```


```python
d1.shape[0], p*d.shape[0]*19*9
```




    (106, 14.26434381910547)




```python
d1['Epitope', 'Parent Species'].unique()
```




    array(['Hepatitis B virus', 'Mycobacterium tuberculosis',
           'Borreliella burgdorferi', 'Hepacivirus C', 'Plasmodium vivax',
           'Plasmodium falciparum', 'Chlamydia trachomatis',
           'Human gammaherpesvirus 4', 'Human metapneumovirus',
           'Trypanosoma cruzi', 'Mycobacterium kansasii',
           'Human alphaherpesvirus 1', 'Alphapapillomavirus 9',
           'Mycobacterium leprae', 'Dengue virus', 'Leishmania major',
           'Human betaherpesvirus 5'], dtype=object)



# Analysis of flu epitopes


```python
fluepis = df_t[df_t['Epitope', 'Parent Species'] == 'Influenza A virus']#['Epitope', 'Description'].unique()
fluepis.shape
```




    (3024, 141)




```python
fluepis['Epitope', 'Description'].unique().shape
```




    (1266,)




```python
plt.hist([len(s) for s in fluepis['Epitope', 'Description'].unique()], bins=np.arange(8, 21))
```




    (array([ 13., 114.,  58.,  27.,  14.,  65.,  31.,  86.,  53., 314., 234.,
            196.]),
     array([ 8,  9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]),
     <a list of 12 Patch objects>)




![png](notebook_files/nn_analysis_16_1.png)



```python
nchunks = 100
btdist = BallTreeDist(human9, nchunks=nchunks)
```


```python
fludists = [btdist.mindist(e) for e in fluepis[fluepis['Epitope', 'Description'].apply(len)==9]]
```


    ---------------------------------------------------------------------------

    KeyError                                  Traceback (most recent call last)

    <ipython-input-19-0eb73821c06c> in <module>
    ----> 1 fludists = [btdist.mindist(e) for e in fluepis[fluepis['Epitope', 'Description'].apply(len)==9]]
    

    <ipython-input-19-0eb73821c06c> in <listcomp>(.0)
    ----> 1 fludists = [btdist.mindist(e) for e in fluepis[fluepis['Epitope', 'Description'].apply(len)==9]]
    

    ~/repos/peptidome/code/lib/neighbors.py in mindist(self, sequence)
         17 
         18     def mindist(self, sequence):
    ---> 19         sequence_number= map_aatonumber(sequence).reshape(1, -1)
         20         d = min(bt.query(sequence_number)[0] for bt in self.bts)
         21         return int(d*len(sequence))


    ~/repos/peptidome/code/lib/main.py in map_aatonumber(seq)
        357     """
        358     seq = np.array(list(seq))
    --> 359     return np.vectorize(_aatonumber.__getitem__)(seq)
        360 
        361 def map_numbertoaa(seq):


    ~/.conda/envs/py3/lib/python3.6/site-packages/numpy/lib/function_base.py in __call__(self, *args, **kwargs)
       2089             vargs.extend([kwargs[_n] for _n in names])
       2090 
    -> 2091         return self._vectorize_call(func=func, args=vargs)
       2092 
       2093     def _get_ufunc_and_otypes(self, func, args):


    ~/.conda/envs/py3/lib/python3.6/site-packages/numpy/lib/function_base.py in _vectorize_call(self, func, args)
       2159             res = func()
       2160         else:
    -> 2161             ufunc, otypes = self._get_ufunc_and_otypes(func=func, args=args)
       2162 
       2163             # Convert args to object arrays first


    ~/.conda/envs/py3/lib/python3.6/site-packages/numpy/lib/function_base.py in _get_ufunc_and_otypes(self, func, args)
       2119 
       2120             inputs = [arg.flat[0] for arg in args]
    -> 2121             outputs = func(*inputs)
       2122 
       2123             # Performance note: profiling indicates that -- for simple


    KeyError: 'Reference'



```python
proteomes = load_proteomes()

```


```python
df_flua = counter_to_df(count_kmers_proteome(datadir + proteomes.loc['InfluenzaA']['path'], 9), norm=True)
df_flua.head()
```


```python
distss = []
for i in range(3):
    peptides = np.random.choice(df_flua['seq'], size=len(fludists), replace=False, p=df_flua['freq'])
    dists = [btdist.mindist(e) for e in peptides]
    distss.append(dists)
```


```python
counts = np.bincount(fludists)
print(counts)
plt.plot(counts, 'o')
for d in [distss[0], distss[1], distss[2]]:
    counts = np.bincount(d)
    print(counts)
    plt.plot(counts, 'kx')
```


```python
def dist2(x):
    for i in range(len(x)):
        for j in range(i+1, len(x)):
            for aai in aminoacids:
                si = x[:i]+aai+x[i+1:]
                for aaj in aminoacids:
                    if (aai == x[i]) and (aaj == x[j]):
                        continue
                    if si[:j]+aaj+si[j+1:] in human9:
                        return True
    return False
```


```python
def dists_direct(df, ref):
    d0 = df[df['seq'].apply(lambda x: x in ref)].shape[0]/df['seq'].shape[0]
    d1 = df[df['seq'].apply(dist1)].shape[0]/df['seq'].shape[0]
    d2 = df[df['seq'].apply(dist2)].shape[0]/df['seq'].shape[0]
    return d0, d1, d2
```


```python
distsallflu = dists_direct(df_flua, human9)
```


```python
counts = np.bincount(fludists)
plt.plot(counts/np.sum(counts), 'o')
plt.plot(distsallflu, 'x')

N = sum(counter9.values())
print('%e'%N)
k = 9
K = 20**k

dists = np.arange(6)
Nc = lambda d: 19**dists * falling_factorial(k, dists+1)
cumulative = [0]
cumulative.extend(1-np.exp(-Nc(dists)*N/K))
plt.plot(dists, np.diff(cumulative), '+')
plt.ylim(0.0)
```


```python
hivepis = d[d['Epitope', 'Parent Species'] == 'Human immunodeficiency virus 1']['Epitope', 'Description'].unique()
hivepis.shape
```


```python
hivdists = [mindist_sklearn_chunked(e, bts) for e in hivepis]
```


```python
counts = np.bincount(hivdists)
print(counts)
plt.plot(counts, 'x')
```


```python
df_hiv1 = counter_to_df(count_kmers_proteome(datadir + proteomes.loc['HIV']['path'], 9), norm=True)
df_hiv1.head()
```


```python
distss_hiv = []
for i in range(3):
    peptides = np.random.choice(df_hiv1['seq'], size=len(hivdists), replace=False, p=df_hiv1['freq'])
    dists = [mindist_sklearn_chunked(e, bts) for e in peptides]
    distss_hiv.append(dists)
```


```python
counts = np.bincount(hivdists)
print(counts)
plt.plot(counts, 'o')
for d in distss_hiv:
    counts = np.bincount(d)
    print(counts)
    plt.plot(counts, 'kx')
```


```python
distsallhiv = dists_direct(df_hiv1, human9)
```


```python
counts = np.bincount(hivdists)
plt.plot(counts/np.sum(counts), 'o')
plt.plot(distsallhiv, 'x')
N = sum(counter9.values())
print('%e'%N)
k = 9
K = 20**k

dists = np.arange(6)
Nc = lambda d: 19**dists * falling_factorial(k, dists+1)
cumulative = [0]
cumulative.extend(1-np.exp(-Nc(dists)*N/K))
plt.plot(dists, np.diff(cumulative), '+')
plt.ylim(0.0)
```


```python

```
#### benchmark.ipynb


# Benchmarking hamming distance calculation


```python
import numpy as np
import pandas as pd
from scipy.stats import entropy
import scipy.stats
import seaborn as sns
import sklearn.neighbors
import matplotlib.pyplot as plt
%matplotlib inline

import Levenshtein

import sys
sys.path.append('..')

from lib import *
```


```python
k = 9
counter9 = count_kmers_proteome(human, k, clean=True)
human9 = set(counter9)
```


```python
humansample = random.sample(human9, 100000)
points = np.asarray([map_aatonumber(h) for h in humansample])

```


```python
def mindist(x, sample):
    return min(Levenshtein.hamming(s, x) for s in sample)
```


```python
mindist('AAACCCAAA', humansample)
```




    3




```python
%timeit -t mindist('AAACCCAAA', humansample)
```

    39.8 ms ± 1.24 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)



```python
bt = sklearn.neighbors.BallTree(points, metric='hamming')
```


```python
def mindist_sklearn(x, tree):
    d, i = tree.query(map_aatonumber(x).reshape(1, -1))
    return int(d*len(x))
```


```python
mindist_sklearn('AAACCCAAA', bt)
```




    3




```python
%timeit -t mindist_sklearn('AAACCCAAA', bt)
```

    6.2 ms ± 224 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)


## on all 9mers 


```python
mindist('AAACCCAAA', human9)
```




    2




```python
%timeit -t mindist('AAACCCAAA', human9)
```

    4.42 s ± 182 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)



```python
nchunks = 100
```


```python
human9_number = np.asarray([map_aatonumber(h) for h in human9])
```


```python
pointss = np.array_split(human9_number, nchunks)
```


```python
bts = [sklearn.neighbors.BallTree(points, metric='hamming') for points in pointss]
```


```python
def mindist_sklearn_chunked(x, trees):
    d = min(bt.query(map_aatonumber(x).reshape(1, -1))[0] for bt in trees)
    return int(d*len(x))
```


```python
mindist_sklearn_chunked('AAACCCAAA', bts)
```




    2




```python
%timeit -t mindist_sklearn_chunked('AAACCCAAA', bts)
```

    711 ms ± 44.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)



```python
btdist = BallTreeDist(human9, nchunks=nchunks)
```


```python
btdist.mindist('AAACCCAAA')
```




    2




```python
%timeit -t btdist.mindist('AAACCCAAA')
```

    695 ms ± 45.8 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)



```python

```
#### math.ipynb


# How does neighbor density relate to likelihoods ?


```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
%matplotlib inline
plt.style.use('../peptidome.mplstyle')
#plt.style.use('talk')

import sys
sys.path.append('..')

from lib import *
```

## check summation formula


```python
def neighbors(sigma, S):
    for i in range(len(sigma)):
        for s in range(S):
            if not sigma[i] == s:
                yield np.asarray(list(sigma[:i]) + [s] + list(sigma[i+1:]))

S = 2
k = 2
sigma_lognormal = 1.0
pi = np.random.lognormal(sigma=sigma_lognormal, size=S)
pi /= pi.sum()
sigma = np.random.randint(0, S, k)
nsigma = np.prod(pi[sigma])*(np.sum(1/pi[sigma]) - k)
nsigma_sum = np.sum(np.fromiter((np.prod(pi[sigmap]) for sigmap in neighbors(sigma, S)), np.float))
print(nsigma, nsigma_sum)
```

    0.5961995584857569 0.596199558485757


## correlation between probabilities


```python
S = 20
k = 10
sigma = 0.3
pi = np.random.lognormal(sigma=sigma, size=S)
pi /= pi.sum()
psigmas = []
psigmaps = []
Nsample = 10000
for i in range(Nsample):
    sigma = np.random.randint(0, S, k)
    psigma = np.prod(pi[sigma])
    i = np.random.randint(0, k)
    sigmai = np.random.choice([s for s in range(0, S) if s != sigma[i]])
    sigmap = np.asarray(list(sigma[:i]) + [sigmai] + list(sigma[i+1:]))
    psigmap = np.prod(pi[sigmap])
    psigmas.append(psigma)
    psigmaps.append(psigmap)
psigmaps = np.asarray(psigmaps)
psigmas = np.asarray(psigmas)
```


```python
fig, ax = plt.subplots(figsize=(3.42, 3.42))
trans = np.log10
ax.plot(trans(psigmas), trans(psigmaps), '.', label='data', ms=1)
ax.plot(trans(psigmas), trans(psigmas), '-', label='linear')
#psigmas_theory = np.linspace(0.5*S**(-k), 2*S**(-k))
#ax.plot(np.log10(psigmas_theory), np.log10(psigmas_theory)+np.log10(k*(S-1)-S*(psigmas_theory*S**k-1)),
#        '-', label='theory')
#ax.plot([-k*np.log10(S)], [-k*np.log10(S) + np.log10(k*(S-1))], 'o')
ax.set_xlabel('$\log_{10} p(\sigma)$')
ax.set_ylabel("$\log_{10} p(\sigma')$")
```




    Text(0, 0.5, "$\\log_{10} p(\\sigma')$")




![png](notebook_files/math_6_1.png)



```python
rhop = np.corrcoef(psigmaps, psigmas)[0, 1]
rhop, np.corrcoef(np.log(psigmaps), np.log(psigmas))[0, 1]
```




    (0.8794155515495672, 0.8973915310674747)



## generate samples from P_uniform(psigma, nsigma)


```python
df = Counter(human, 1).to_df(norm=True, clean=True)
paa = np.asarray(df['freq'])
paa
```




    array([0.02132759, 0.06577845, 0.07012693, 0.06314819, 0.09970845,
           0.08332527, 0.01217275, 0.05643573, 0.05963846, 0.07101057,
           0.02662735, 0.02305051, 0.05347764, 0.0473157 , 0.05724314,
           0.04330068, 0.04767035, 0.02626757, 0.0365297 , 0.03584496])




```python
S = 20
k = 9

Nn = k*(S-1)
N = float(S**k)

#sigma_lognormal = 0.4
#pi = np.random.lognormal(sigma=sigma_lognormal, size=S)
pi = paa
#pi = np.random.uniform(size=S)
pi /= pi.sum()


psigmas = []
nsigmas = []
Nsample = 100000
for i in range(Nsample):
    sigma = np.random.randint(0, S, k)
    psigma = np.prod(pi[sigma])
    nsigma = np.prod(pi[sigma])*np.sum((1-pi[sigma])/pi[sigma])
    psigmas.append(psigma)
    nsigmas.append(nsigma)
nsigmas = np.asarray(nsigmas)
psigmas = np.asarray(psigmas)
rho = np.corrcoef(psigmas, nsigmas)[1, 0]
print(r'$\rho_{p(\sigma), n(\sigma)}$:', rho)
```

    $\rho_{p(\sigma), n(\sigma)}$: 0.9904111764408798



```python
np.var(np.log(psigmas))/k, np.var(np.log(pi))
```




    (0.26489179882187436, 0.2637393500109682)




```python
sigmasq = np.var(np.log(pi))*k
np.var(psigmas), (np.exp(sigmasq)-1)/N**2
```




    (1.5518235808418035e-23, 3.714200465543339e-23)




```python
fig, ax = plt.subplots(figsize=(3.42, 3.42))
ax.plot(np.log10(psigmas), np.log10(nsigmas), '.', label='data', ms=1)
ax.plot(np.log10(psigmas), np.log10(psigmas)+np.log10(k*(S-1)), '-', label='linear')
#factor = 20
#psigmas_theory = np.linspace(S**(-k)/factor, factor*S**(-k))
psigmas_theory = np.linspace(min(psigmas), max(psigmas))
ax.plot(np.log10(psigmas_theory),
        #np.log10(psigmas_theory) + np.log10(Nn - S*(psigmas_theory*float(S**k) - 1)),
        np.log10(psigmas_theory) + np.log10(Nn - S*np.log(psigmas_theory*N)),
        'k-', label='theory', lw=2)
#ax.axvline(-k*np.log10(S), c='k')
ax.set_xlabel('$\log_{10} p(\sigma)$\n Log-Likelihood')
ax.set_ylabel("Log-Neighborlikelihood\n $\log_{10} n(\sigma) = \log_{10} \sum_{\sigma' \sim \sigma} p(\sigma')$")
ax.legend()
fig.savefig('main.png')

slope, intercept = np.polyfit(np.log10(psigmas), np.log10(nsigmas), 1)
rho1 = 1 - S/(k*(S-1))
print('slope, prediction', slope, rho1)
nsigmavar_pred = np.var(psigmas)* Nn**2 * rho1**2
nsigmavar_pred2 = Nn*np.var(psigmas)*(1+(Nn-1)*rhop)
print('nsigmavar (sampled, upper, pred):',
      np.var(nsigmas),
      np.var(psigmas)*Nn**2,
      nsigmavar_pred,
      nsigmavar_pred2)
nsigmabar = np.sum(nsigmas*psigmas/np.sum(psigmas))
nsigmabar_upper = Nn*np.mean(psigmas**2)*N
nsigmabar_pred = Nn/N + N*Nn*rho1*np.var(psigmas)
nsigmabar_pred2 = Nn/N + N*(Nn-1.5*S)*np.var(psigmas)
nsigmabar_pred3 = Nn/N + N*(np.var(psigmas) * nsigmavar_pred2)**.5
print('nsigmabar (lower, sampled, upper):', Nn/N, nsigmabar, nsigmabar_upper)
print('prediction (-S, -3/2S, rhop)', nsigmabar_pred, nsigmabar_pred2, nsigmabar_pred3)
```

    slope, prediction 0.8655586372960176 0.8830409356725146
    nsigmavar (sampled, upper, pred): 2.8128526752865896e-19 4.537687332739518e-19 3.5383129466773965e-19 3.993712659499665e-19
    nsigmabar (lower, sampled, upper): 3.33984375e-10 1.387208081120254e-09 1.697763829483453e-09
    prediction (-S, -3/2S, rhop) 1.5337302218204152e-09 1.454276854481315e-09 1.6086008919132467e-09



![png](notebook_files/math_13_1.png)



```python
bins = np.linspace(0.0, np.percentile(nsigmas, 99), 100)
fig, ax = plt.subplots()
histkwargs = dict(bins=bins, histtype='step')
ax.hist(psigmas*k*(S-1), label='$P(\sigma)$ rescaled', **histkwargs)
ax.hist(nsigmas, label='$n(\sigma)$', **histkwargs)
ax.legend()
ax.axvline(1/S**k * k*(S-1), c='k')
ax.set_xlim(min(bins), max(bins))
ax.set_yticks([])
ax.set_ylabel('Density')
ax.set_xlabel('Probability');
```


![png](notebook_files/math_14_0.png)


## TODO

- Check these formulas!
- What about longer distances? (Second, third neighbours etc.?) Do things generalize?
- Test with rough Mount Fuji?


```python

```
