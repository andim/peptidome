import subprocess
import os
import pandas as pd

FNULL = open(os.devnull, 'w') # Mute the subprocess (prevents shell cluttering)

repopath = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
netmhcpath = os.path.join(repopath, 'dependencies/netMHC-4.0/netMHC')

def run_netMHC(inputpath, outname, hla, binder_only=True):
    """run netMHC on a fasta file

    binder_only: filter to only keep high binders < 500nM

    """
    inputpath = os.path.abspath(inputpath)
    peptides = inputpath.endswith('csv') or inputpath.endswith('txt')
    fullout = os.path.abspath('%s-%s.csv' % (outname, hla))
    if not os.path.exists(fullout):
        #netMHC -f fasta -xls -xlsfile out.csv -a HLA-A0101
        print("{netmhcpath} -f {inputpath} -xls -xlsfile {fullout} -a {hla}".format(netmhcpath=netmhcpath,
              inputpath=inputpath, fullout=fullout, hla=hla))
        if peptides:
            subprocess.run([netmhcpath, '-f', inputpath,
                            '-xls',
                            '-xlsfile %s' % fullout,
                            '-a %s'%hla,
                            '-p'],
                            # Mute the subprocess (prevents shell cluttering)
                            stdout=FNULL, stderr=subprocess.STDOUT)
        else:
            subprocess.run([netmhcpath, '-f', inputpath,
                            '-xls',
                            '-xlsfile %s' % fullout,
                            '-a %s'%hla],
                            # Mute the subprocess (prevents shell cluttering)
                            stdout=FNULL, stderr=subprocess.STDOUT)
        if binder_only:
            df = pd.read_csv(fullout, sep='\t', skiprows=1)
            dfbinders = df[df['nM']<500]
            dfbinders.to_csv(fullout)
